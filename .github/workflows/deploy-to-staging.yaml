---
name: Deploy submodule updates to the staging environment

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy-app:
        description: Deloy the app to staging
        type: boolean
        default: true
      deploy-tenant-manager:
        description: Deploy the tenant manager to staging
        type: boolean
        default: true


jobs:
  cloud_deployment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: false
          persist-credentials: false

      - name: Set up files changed
        id: files
        run: |
          echo "before: ${{ github.event.before }}"
          echo "now: ${{ github.sha }}"
          echo "::set-output name=files-changed::$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})"
          echo "::set-output name=app-commit::$(git ls-tree HEAD components/app | awk '{print $3}')"
          echo "::set-output name=tenant-manager-commit::$(git ls-tree HEAD components/tenant-manager | awk '{print $3}')"

      - name: Generate a token
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.TENZIR_AUTOBUMPER_APP_ID }}
          private-key: ${{ secrets.TENZIR_AUTOBUMPER_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Prepare git push
        env:
          GITHUB_APP_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          git config --global user.name 'tenzir-bot'
          git config --global user.email 'engineering@tenzir.com'
          git remote set-url origin https://x-access-token:$GITHUB_APP_TOKEN@github.com/tenzir/platform.git

      - name: Configure ssh-agent for tenant-manager submodule
        if: |
          (github.event_type == 'workflow_dispatch' && inputs.deploy-tenant-manager) || 
          (github.event_type == 'push' && contains(${{ steps.files.outputs.files-changed }}, 'components/tenant-manager')
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.TENZIR_EVENT_HORIZON_DEPLOY_KEY }}

      - name: Deploy tenant-manager
        if: |
          (github.event_type == 'workflow_dispatch' && inputs.deploy-tenant-manager) || 
          (github.event_type == 'push' && contains(${{ steps.files.outputs.files-changed }}, 'components/tenant-manager')
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          git submodule update --init components/tenant-manager
          git -C components/tenant-manager checkout platform-staging
          git -C components/tenant-manager reset --hard ${{ steps.files.outputs.tenant-manager-commit }}
          git -C components/tenant-manager push -f
          # The workflow_dispatch only supports tags or branches as targets,
          # not direct commit hashes.
          gh workflow -R tenzir/event-horizon run tzcp-deploy-staging.yaml \
            --ref platform-staging

      - name: Configure ssh-agent for app submodule
        if: |
          (github.event_type == 'workflow_dispatch' && inputs.deploy-app) || 
          (github.event_type == 'push' && contains(${{ steps.files.outputs.files-changed }}, 'components/app')
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.TENZIR_APP_DEPLOY_KEY }}

      - name: Deploy app
        if: |
          (github.event_type == 'workflow_dispatch' && inputs.deploy-app) || 
          (github.event_type == 'push' && contains(${{ steps.files.outputs.files-changed }}, 'components/app')
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          gh workflow -R tenzir/app run deploy-to-vercel.yaml \
            --ref ${{ steps.files.outputs.app-commit }} \
            -f deploy-staging=true
